name: Deploy

on:
  pull_request:
    types: [closed]
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-18.04
    if: github.event.pull_request.merged

    env:
      GOOGLE_PASSPHRASE: ${{ secrets.google_passphrase }}
      COMPOSER_PASSPHRASE: ${{ secrets.composer_passphrase }}
      VARIABLES_PASSPHRASE: ${{ secrets.variables_passphrase }}

    steps:
    - uses: actions/checkout@v2

    - name: Cache node modules
      uses: actions/cache@v1
      with:
       path: ~/.npm
       key: npm-${{ hashFiles('**/package-lock.json') }}

    - name: Cache PHP dependencies
      uses: actions/cache@v1
      with:
       path: ~/.composer
       key: composer-${{ hashFiles('**/composer.lock') }}

    - name: Composer cache permissions
      run: |
           sudo mkdir -p ~/.npm && sudo chown -R $USER ~/.npm
           sudo mkdir -p ~/.composer && sudo chown -R $USER ~/.composer

    - name: Decrypt secrets
      run: |
          gpg --quiet --batch --yes --decrypt --passphrase=$GOOGLE_PASSPHRASE --output google.json .github/secrets/google.json.gpg
          gpg --quiet --batch --yes --decrypt --passphrase=$COMPOSER_PASSPHRASE --output auth.json .github/secrets/composer.json.gpg
          gpg --quiet --batch --yes --decrypt --passphrase=$VARIABLES_PASSPHRASE --output .env .github/secrets/variables.gpg

    - name: Install curl curl zip npm
      run: sudo apt-get update && sudo apt-get install -y curl zip npm

    - name: Install composer
      run: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer

    - name: Validate composer and install prod dependecies
      run: |
          composer validate
          composer install -q --no-dev --optimize-autoloader --no-ansi --no-interaction --no-scripts --no-suggest --no-progress --prefer-dist

    - uses: borales/actions-yarn@v2.0.0
      with:
       cmd: install
    - uses: borales/actions-yarn@v2.0.0
      with:
       cmd: prod

    - name: Install GCloud SDK
      run: if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then rm -rf $HOME/google-cloud-sdk; export CLOUDSDK_CORE_DISABLE_PROMPTS=1; curl https://sdk.cloud.google.com | bash; fi

    - name: Authenticate GCloud and configure default project
      run: |
          gcloud auth activate-service-account --key-file=google.json
          gcloud config set project mossigma-app-production

    - name: Deploy to app-engine
      run: gcloud app deploy --stop-previous-version
