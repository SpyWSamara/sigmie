name: Code style

on: [push]

jobs:

  style_check:
    runs-on: ubuntu-18.04
    if: github.ref != 'refs/heads/master'

    env:
      COMPOSER_PASSPHRASE: ${{ secrets.composer_passphrase }}

    steps:
    - uses: actions/checkout@v2

    - name: Cache node modules
      uses: actions/cache@v1
      with:
       path: ~/.npm
       key: npm-${{ hashFiles('**/package-lock.json') }}

    - name: Cache PHP dependencies
      uses: actions/cache@v1
      with:
       path: ~/.composer
       key: composer-${{ hashFiles('**/composer.lock') }}

    - name: Install curl npm zip
      run: sudo apt-get update && sudo apt-get install -y curl npm zip

    - name: Install composer
      run: curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer

    - name: Decrypt composer secret
      run: gpg --quiet --batch --yes --decrypt --passphrase=$COMPOSER_PASSPHRASE --output auth.json .github/secrets/composer.json.gpg

    - name: Instruct composer to use https protocol over ssh
      run: composer config github-protocols https

    - name: Validate composer.json and composer.lock
      run: composer validate

    - name: Install php dependencies
      run: composer install -q --optimize-autoloader --no-ansi --no-interaction --no-scripts --no-suggest --no-progress --prefer-dist

    - name: Install node
      run:  curl https://nodejs.org/dist/v8.10.0/node-v8.10.0-linux-x64.tar.gz | sudo tar xzvf - --exclude CHANGELOG.md --exclude LICENSE --exclude README.md --strip-components 1 -C /usr/local/

    - name: Upgrade node to latest stable
      run: |
           sudo npm cache clean -f
           sudo npm install -g n
           sudo n stable

    - name: Install node dependencies
      run: npm install

    - name: PHPStan
      run: vendor/bin/phpstan analyse --memory-limit=2G

    - name: PHPCS
      run: vendor/bin/phpcs --standard=standard.xml ./app

    - name: JS Standard
      run: node_modules/standard/bin/cmd.js | node_modules/snazzy/bin/cmd.js
